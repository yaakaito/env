#!/bin/bash

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1" >&2
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1" >&2
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1" >&2
}

# Global variables
BRANCH_NAME=""
DESCRIPTION=""
BASE_BRANCH="main"

show_help() {
    cat << EOF
Usage: git-worktree-add <description> [options]
       git-worktree-add -b <branch_name> [options]

Create a new git worktree.

By default, Claude Code generates a branch name from the description.
Use -b/--branch to specify a branch name directly.

Arguments:
    description    Description of the work (Claude generates branch name)

Options:
    -b, --branch   Specify branch name directly (skip Claude)
    -h, --help     Show this help message

Examples:
    git-worktree-add "Add login feature"
    git-worktree-add "Fix typo in README"
    git-worktree-add -b feature/login

Notes:
    - Dependency installation is handled automatically by Claude Code's SessionStart hook
    - Gitignored files are copied via .worktreeinclude in the repository root

Exit codes:
    0: Success (stdout contains worktree path)
    1: Error
EOF
}

parse_arguments() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            -b|--branch)
                if [[ -z "${2:-}" ]]; then
                    log_error "Option $1 requires a branch name"
                    exit 1
                fi
                BRANCH_NAME="$2"
                shift 2
                ;;
            -h|--help)
                show_help
                exit 0
                ;;
            -*)
                log_error "Unknown option: $1"
                show_help
                exit 1
                ;;
            *)
                if [[ -z "$DESCRIPTION" ]]; then
                    DESCRIPTION="$1"
                else
                    # Append to description (allow multi-word descriptions without quotes)
                    DESCRIPTION="$DESCRIPTION $1"
                fi
                shift
                ;;
        esac
    done

    if [[ -z "$BRANCH_NAME" && -z "$DESCRIPTION" ]]; then
        echo -n "Enter description: " >&2
        read -r DESCRIPTION
        if [[ -z "$DESCRIPTION" ]]; then
            log_error "Description is required"
            exit 1
        fi
    fi
}

check_claude_available() {
    if ! command -v claude &> /dev/null; then
        log_error "Claude CLI is not available. Please install it or use -b/--branch to specify a branch name directly."
        exit 1
    fi
}

generate_branch_name() {
    local description="$1"

    log_info "Generating branch name with Claude..."

    local prompt="Based on this description, suggest a git branch name with appropriate prefix (feature/, fix/, chore/, docs/).
The branch name should be descriptive but concise, using kebab-case.
Only return the branch name, nothing else.

Description: $description"

    local branch_name
    branch_name=$(echo "$prompt" | claude -p 2>/dev/null)

    # Clean up the response (remove any extra whitespace, quotes, or backticks)
    branch_name=$(echo "$branch_name" | tr -d '"\`' | xargs)

    if [[ -z "$branch_name" ]]; then
        log_error "Failed to generate branch name"
        exit 1
    fi

    echo "$branch_name"
}

find_git_root() {
    # Use git rev-parse to get the toplevel directory
    local toplevel
    toplevel=$(git rev-parse --show-toplevel 2>/dev/null)
    if [[ -n "$toplevel" ]]; then
        echo "$toplevel"
        return 0
    fi

    log_error "Not in a git repository"
    exit 1
}

generate_suffix() {
    tr -dc 'a-zA-Z0-9' < /dev/urandom | head -c 6
}

create_worktree() {
    local repo_root="$1"
    local branch_name="$2"
    local suffix
    suffix=$(generate_suffix)
    local unique_branch="${branch_name}-${suffix}"
    local worktree_dir="$repo_root/.worktrees/$unique_branch"

    # Create the .worktrees directory if it doesn't exist
    mkdir -p "$repo_root/.worktrees"

    # Prune stale worktree entries
    git worktree prune

    log_info "Creating worktree for branch: $unique_branch (base: $BASE_BRANCH)"
    if ! git worktree add "$worktree_dir" -b "$unique_branch" "$BASE_BRANCH" >&2; then
        log_error "Failed to create worktree"
        exit 1
    fi

    echo "$worktree_dir"
}

main() {
    parse_arguments "$@"

    # Generate branch name if not specified directly
    if [[ -z "$BRANCH_NAME" ]]; then
        check_claude_available
        BRANCH_NAME=$(generate_branch_name "$DESCRIPTION")
        log_success "Generated branch name: $BRANCH_NAME"
    fi

    log_info "Creating worktree for branch: $BRANCH_NAME"

    # Find git repository root
    local repo_root
    repo_root=$(find_git_root)
    log_success "Found git repository at: $repo_root"

    # Create worktree
    local worktree_dir
    worktree_dir=$(create_worktree "$repo_root" "$BRANCH_NAME")

    log_success "Worktree created successfully!"

    # Output worktree path to stdout (for shell integration)
    echo "$worktree_dir"
}

main "$@"
